"use client"

import { useState } from "react"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Download, FileSpreadsheet, Calculator } from "lucide-react"
import * as XLSX from 'xlsx'
import { saveAs } from 'file-saver'

export function FormulaTemplateGenerator() {
  const [isGenerating, setIsGenerating] = useState(false)

  const generateTemplate = async () => {
    setIsGenerating(true)
    
    try {
      // Создаем рабочую книгу
      const workbook = XLSX.utils.book_new()
      
      // Лист с настройками
      const settingsData = [
        ["Параметр", "Значение", "Описание", "Единицы измерения"],
        ["Финансовая нагрузка (%)", 5, "Процент финансовой нагрузки", "%"],
        ["НДС (%)", 12, "Ставка НДС", "%"],
        ["Бонус менеджера (%)", 3, "Процент бонуса менеджера", "%"],
        ["Налог на бонус клиента (%)", 32, "Налог на бонус клиента", "%"],
        ["КПН (%)", 20, "Корпоративный подоходный налог", "%"],
      ]
      
      const settingsSheet = XLSX.utils.aoa_to_sheet(settingsData)
      
      // Настройка ширины колонок
      settingsSheet['!cols'] = [
        { wch: 25 },
        { wch: 15 },
        { wch: 40 },
        { wch: 20 }
      ]
      
      XLSX.utils.book_append_sheet(workbook, settingsSheet, "Настройки")
      
      // Лист с формулами
      const formulasData = [
        ["Буква", "Название", "Формула", "Кастомная формула", "Описание"],
        ["D", "Количество", "D", "D", "Количество товара"],
        ["E", "Цена закупки", "E", "E", "Цена закупки за единицу"],
        ["H", "Общая доставка", "H", "H", "Общая стоимость доставки"],
        ["F", "Доставка за единицу", "F = H / D", "F = H / D", "Доставка на единицу товара"],
        ["G", "Сумма за ед. с доставкой", "G = E + F", "G = E + F", "Себестоимость с доставкой"],
        ["I", "Финансовая нагрузка (%)", "I = 5%", "I = 5%", "Процент финансовой нагрузки"],
        ["J", "Финансовая нагрузка", "J = G * (I / 100)", "J = G * (I / 100)", "Сумма финансовой нагрузки"],
        ["K", "Сумма с нагрузкой", "K = G + J", "K = G + J", "Себестоимость с финансовой нагрузкой"],
        ["Q", "Цена продажи с бонусом", "Q", "Q", "Цена продажи с учетом бонуса клиента"],
        ["AE", "Бонус клиента", "AE", "AE", "Общий бонус клиента"],
        ["AD", "Бонус за ед.", "AD = AE / D", "AD = AE / D", "Бонус клиента на единицу"],
        ["P", "Цена продажи с НДС", "P = Q - AD", "P = Q - AD", "Цена продажи без бонуса клиента"],
        ["M", "Накрутка", "M = P - K", "M = P - K", "Маржа в денежном выражении"],
        ["L", "% накрутки", "L = (M / K) * 100", "L = (M / K) * 100", "Маржа в процентах"],
        ["N", "Цена без НДС", "N = P - O", "N = P - O", "Цена продажи без НДС"],
        ["O", "НДС", "O = N * (НДС / 100)", "O = N * (НДС / 100)", "Сумма НДС"],
        ["R", "% менеджера", "R = 3%", "R = 3%", "Процент бонуса менеджера"],
        ["S", "Бонус менеджера за ед.", "S = N * (R / 100)", "S = N * (R / 100)", "Бонус менеджера на единицу"],
        ["T", "Доход без КПН", "T = P - E - F - J - S - O", "T = P - E - F - J - S - O", "Доход до вычета КПН"],
        ["U", "КПН", "U = T * (КПН / 100)", "U = T * (КПН / 100)", "Корпоративный подоходный налог"],
        ["V", "Чистый доход за ед.", "V = T - U", "V = T - U", "Чистый доход на единицу"],
        ["W", "Маржа в %", "W = (V / P) * 100", "W = (V / P) * 100", "Рентабельность в процентах"],
        ["X", "Общая сумма с НДС", "X = D * P", "X = D * P", "Общая сумма продажи с НДС"],
        ["Y", "Общая сумма с бонусом", "Y = D * Q", "Y = D * Q", "Общая сумма с учетом бонуса"],
        ["Z", "Сумма чистого дохода", "Z = D * V", "Z = D * V", "Общий чистый доход"],
        ["AA", "Общая сумма закупа", "AA = D * E", "AA = D * E", "Общая стоимость закупки"],
        ["AB", "Сумма общих расходов", "AB = AA + H + (D * J) + (D * S) + (D * O) + (D * U)", "AB = AA + H + (D * J) + (D * S) + (D * O) + (D * U)", "Общие расходы"],
        ["AC", "Общая сумма бонусов менеджера", "AC = D * S", "AC = D * S", "Общие бонусы менеджера"],
        ["AF", "Бонус клиента с вычетом налога", "AF = AE * (1 - налог/100)", "AF = AE * (1 - налог/100)", "Бонус клиента после вычета налогов"],
      ]
      
      const formulasSheet = XLSX.utils.aoa_to_sheet(formulasData)
      
      // Настройка ширины колонок
      formulasSheet['!cols'] = [
        { wch: 8 },
        { wch: 25 },
        { wch: 30 },
        { wch: 30 },
        { wch: 40 }
      ]
      
      XLSX.utils.book_append_sheet(workbook, formulasSheet, "Формулы")
      
      // Лист с примерами расчетов
      const exampleData = [
        ["Параметр", "Обозначение", "Значение", "Описание", "Формула"],
        ["Количество", "D", 100, "Количество товара", "=D3"],
        ["Цена закупки", "E", 1000, "Цена закупки за единицу", "=E3"],
        ["Общая доставка", "H", 5000, "Общая стоимость доставки", "=H3"],
        ["Доставка за единицу", "F", "=H3/D3", "Доставка на единицу товара", "=F3"],
        ["Сумма за ед. с доставкой", "G", "=E3+F3", "Себестоимость с доставкой", "=G3"],
        ["Финансовая нагрузка (%)", "I", 5, "Процент финансовой нагрузки", "=I3"],
        ["Финансовая нагрузка", "J", "=G3*(I3/100)", "Сумма финансовой нагрузки", "=J3"],
        ["Сумма с нагрузкой", "K", "=G3+J3", "Себестоимость с финансовой нагрузкой", "=K3"],
        ["Цена продажи с бонусом", "Q", 1500, "Цена продажи с учетом бонуса клиента", "=Q3"],
        ["Бонус клиента", "AE", 10000, "Общий бонус клиента", "=AE3"],
        ["Бонус за ед.", "AD", "=AE3/D3", "Бонус клиента на единицу", "=AD3"],
        ["Цена продажи с НДС", "P", "=Q3-AD3", "Цена продажи без бонуса клиента", "=P3"],
        ["Накрутка", "M", "=P3-K3", "Маржа в денежном выражении", "=M3"],
        ["% накрутки", "L", "=(M3/K3)*100", "Маржа в процентах", "=L3"],
        ["Цена без НДС", "N", "=P3-O3", "Цена продажи без НДС", "=N3"],
        ["НДС", "O", "=N3*0.12", "Сумма НДС", "=O3"],
        ["% менеджера", "R", 3, "Процент бонуса менеджера", "=R3"],
        ["Бонус менеджера за ед.", "S", "=N3*(R3/100)", "Бонус менеджера на единицу", "=S3"],
        ["Доход без КПН", "T", "=P3-E3-F3-J3-S3-O3", "Доход до вычета КПН", "=T3"],
        ["КПН", "U", "=T3*0.2", "Корпоративный подоходный налог", "=U3"],
        ["Чистый доход за ед.", "V", "=T3-U3", "Чистый доход на единицу", "=V3"],
        ["Маржа в %", "W", "=(V3/P3)*100", "Рентабельность в процентах", "=W3"],
        ["Общая сумма с НДС", "X", "=D3*P3", "Общая сумма продажи с НДС", "=X3"],
        ["Общая сумма с бонусом", "Y", "=D3*Q3", "Общая сумма с учетом бонуса", "=Y3"],
        ["Сумма чистого дохода", "Z", "=D3*V3", "Общий чистый доход", "=Z3"],
        ["Общая сумма закупа", "AA", "=D3*E3", "Общая стоимость закупки", "=AA3"],
        ["Сумма общих расходов", "AB", "=AA3+H3+(D3*J3)+(D3*S3)+(D3*O3)+(D3*U3)", "Общие расходы", "=AB3"],
        ["Общая сумма бонусов менеджера", "AC", "=D3*S3", "Общие бонусы менеджера", "=AC3"],
        ["Бонус клиента с вычетом налога", "AF", "=AE3/1.32", "Бонус клиента после вычета налогов", "=AF3"],
      ]
      
      const exampleSheet = XLSX.utils.aoa_to_sheet(exampleData)
      
      // Настройка ширины колонок
      exampleSheet['!cols'] = [
        { wch: 25 },
        { wch: 8 },
        { wch: 15 },
        { wch: 40 },
        { wch: 50 }
      ]
      
      XLSX.utils.book_append_sheet(workbook, exampleSheet, "Примеры расчетов")
      
      // Лист с инструкциями
      const instructionsData = [
        ["ИНСТРУКЦИЯ ПО ИСПОЛЬЗОВАНИЮ ШАБЛОНА ФОРМУЛ"],
        [""],
        ["1. НАСТРОЙКИ"],
        ["   - Откройте лист 'Настройки'"],
        ["   - Измените значения в колонке 'Значение' для настройки параметров"],
        ["   - Сохраните изменения"],
        [""],
        ["2. ФОРМУЛЫ"],
        ["   - Откройте лист 'Формулы'"],
        ["   - В колонке 'Кастомная формула' можете изменить формулы"],
        ["   - Используйте обозначения: D, E, F, G, H, I, J, K, L, M, N, O, P, Q, R, S, T, U, V, W, X, Y, Z, AA, AB, AC, AD, AE, AF"],
        ["   - Пример: L = (M / K) * 100  - формула для расчета процента накрутки"],
        [""],
        ["3. ПРИМЕРЫ РАСЧЕТОВ"],
        ["   - Откройте лист 'Примеры расчетов'"],
        ["   - Измените значения в колонке 'Значение' для тестирования"],
        ["   - Формулы автоматически пересчитаются"],
        [""],
        ["4. ИМПОРТ В СИСТЕМУ"],
        ["   - Сохраните файл после редактирования"],
        ["   - Используйте функцию 'Импорт из Excel' в системе"],
        ["   - Выберите сохраненный файл"],
        [""],
        ["5. ОБОЗНАЧЕНИЯ ПЕРЕМЕННЫХ"],
        ["   D - Количество товара"],
        ["   E - Цена закупки за единицу"],
        ["   F - Доставка за единицу"],
        ["   G - Сумма за единицу с доставкой"],
        ["   H - Общая доставка"],
        ["   I - Финансовая нагрузка (%)"],
        ["   J - Финансовая нагрузка"],
        ["   K - Сумма с финансовой нагрузкой"],
        ["   L - Процент накрутки"],
        ["   M - Накрутка"],
        ["   N - Цена без НДС"],
        ["   O - НДС"],
        ["   P - Цена продажи с НДС"],
        ["   Q - Цена продажи с бонусом клиента"],
        ["   R - Процент бонуса менеджера"],
        ["   S - Бонус менеджера за единицу"],
        ["   T - Доход без КПН"],
        ["   U - КПН"],
        ["   V - Чистый доход за единицу"],
        ["   W - Маржа в процентах"],
        ["   X - Общая сумма продажи с НДС"],
        ["   Y - Общая сумма с бонусом"],
        ["   Z - Сумма чистого дохода"],
        ["   AA - Общая сумма закупа"],
        ["   AB - Сумма общих расходов"],
        ["   AC - Общая сумма бонусов менеджера"],
        ["   AD - Бонус клиента за единицу"],
        ["   AE - Общий бонус клиента"],
        ["   AF - Бонус клиента с вычетом налогов"],
      ]
      
      const instructionsSheet = XLSX.utils.aoa_to_sheet(instructionsData)
      
      // Настройка ширины колонок
      instructionsSheet['!cols'] = [
        { wch: 80 }
      ]
      
      XLSX.utils.book_append_sheet(workbook, instructionsSheet, "Инструкции")
      
      // Экспортируем файл
      const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' })
      const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' })
      saveAs(blob, `formulas-template-${new Date().toISOString().split('T')[0]}.xlsx`)
      
    } catch (error) {
      console.error('Ошибка при создании шаблона:', error)
    } finally {
      setIsGenerating(false)
    }
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Calculator className="h-5 w-5" />
          Генератор шаблона формул
        </CardTitle>
        <CardDescription>
          Создайте Excel шаблон с формулами для настройки расчетов
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          <div className="space-y-2">
            <h4 className="font-medium">Создать шаблон Excel</h4>
            <p className="text-sm text-muted-foreground">
              Создаст Excel файл с готовыми формулами, настройками и примерами расчетов
            </p>
            <Button 
              onClick={generateTemplate} 
              disabled={isGenerating}
              className="w-full"
            >
              <FileSpreadsheet className="h-4 w-4 mr-2" />
              {isGenerating ? "Создание шаблона..." : "Создать шаблон Excel"}
            </Button>
          </div>
          
          <div className="text-xs text-muted-foreground space-y-1">
            <p><strong>Что включает шаблон:</strong></p>
            <ul className="list-disc list-inside space-y-1 ml-2">
              <li>Лист "Настройки" - параметры системы</li>
              <li>Лист "Формулы" - все формулы с возможностью редактирования</li>
              <li>Лист "Примеры расчетов" - рабочие примеры с формулами Excel</li>
              <li>Лист "Инструкции" - подробное руководство по использованию</li>
            </ul>
          </div>
        </div>
      </CardContent>
    </Card>
  )
}
